<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Puppeteer Tabbed Browser</title>
<style>
body{margin:0;font-family:sans-serif;display:flex;flex-direction:column;height:100vh;}
#toolbar{background:#222;color:#fff;padding:5px;display:flex;gap:5px;}
#tabs{background:#333;color:#fff;padding:5px;display:flex;gap:5px;overflow-x:auto;}
#tabs button{padding:5px 10px;cursor:pointer;border:none;background:#444;color:#fff;border-radius:4px;display:flex;align-items:center;gap:5px;}
#tabs button.active{background:#16a34a;}
#view{flex:1;overflow:auto;border-top:1px solid #ccc;}
input.url{flex:1;padding:5px;border-radius:4px;border:none;}
button{cursor:pointer;border:none;padding:5px 10px;border-radius:4px;background:#16a34a;color:#fff;}
img.favicon{width:16px;height:16px;}
</style>
</head>
<body>

<div id="toolbar">
  <button id="newTab">New Tab</button>
  <button id="back">◀</button>
  <button id="forward">▶</button>
  <input id="url" class="url" placeholder="Enter URL...">
  <button id="go">Go</button>
</div>

<div id="tabs"></div>
<div id="view"><div id="content">No tabs open.</div></div>

<script>
let tabs = [];
let currentTab = null;

async function createTab() {
  const res = await fetch("/new-tab");
  const data = await res.json();
  const tab = { id: data.tabId, url: null, title: "New Tab", favicon: null };
  tabs.push(tab);
  switchTab(tab.id);
  renderTabs();
}

function renderTabs() {
  const tabsDiv = document.getElementById("tabs");
  tabsDiv.innerHTML = "";
  tabs.forEach(t => {
    const btn = document.createElement("button");
    if(t.favicon){
      const img = document.createElement("img");
      img.src = t.favicon;
      img.className = "favicon";
      btn.appendChild(img);
    }
    const span = document.createElement("span");
    span.textContent = t.title;
    btn.appendChild(span);

    if(t.id === (currentTab && currentTab.id)) btn.className += " active";

    btn.onclick = () => switchTab(t.id);

    const closeBtn = document.createElement("span");
    closeBtn.textContent = "✖";
    closeBtn.style.marginLeft = "5px";
    closeBtn.style.cursor = "pointer";
    closeBtn.onclick = async (e) => {
      e.stopPropagation();
      await fetch(`/close-tab?tabId=${t.id}`);
      tabs = tabs.filter(tab=>tab.id!==t.id);
      if(currentTab.id===t.id) currentTab = tabs[0] || null;
      renderTabs();
      if(currentTab && currentTab.url) loadUrl(currentTab.url);
      else document.getElementById("content").innerHTML="No tabs open.";
    };
    btn.appendChild(closeBtn);

    tabsDiv.appendChild(btn);
  });
}

function switchTab(id) {
  currentTab = tabs.find(t=>t.id===id);
  renderTabs();
  if(currentTab.url) loadUrl(currentTab.url);
}

async function loadUrl(url) {
  if(!currentTab) return alert("No tab selected");
  document.getElementById("content").innerHTML = "Loading...";
  try {
    const res = await fetch(`/navigate?tabId=${currentTab.id}&url=${encodeURIComponent(url)}`);
    const data = await res.json();
    document.getElementById("content").innerHTML = data.html;
    currentTab.url = url;
    currentTab.title = data.title || url;
    currentTab.favicon = data.favicon || null;
    document.getElementById("url").value = url;
    renderTabs();
  } catch(e){
    document.getElementById("content").innerHTML = "Failed to load: "+e.message;
  }
}

document.getElementById("newTab").onclick = () => createTab();
document.getElementById("go").onclick = () => loadUrl(document.getElementById("url").value);
document.getElementById("url").addEventListener("keydown", e => { if(e.key==="Enter") loadUrl(e.target.value); });

document.getElementById("back").onclick = async ()=>{
  if(!currentTab) return;
  await fetch(`/go-back?tabId=${currentTab.id}`);
  loadUrl(currentTab.history[currentTab.historyIndex-1]);
}

document.getElementById("forward").onclick = async ()=>{
  if(!currentTab) return;
  await fetch(`/go-forward?tabId=${currentTab.id}`);
  loadUrl(currentTab.history[currentTab.historyIndex+1]);
}

// Start with one tab
createTab();
</script>

</body>
  </html>
